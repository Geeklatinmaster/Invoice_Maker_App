<!doctype html>
<html lang="es">
  <head>
    <meta charset="utf-8" />
    <title>Invoice Print</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <style>
      /* Live Customizer CSS Variables - same as ThemeVars.tsx */
      :root{
        --acc:#2d3e8b; --acc2:#9bb3d4; --txt:#111; --txtMuted:#6b7280; --bg:#fff; --surface:#fafafa; --border:#e5e7eb;
        --heading:system-ui; --body:system-ui; --hW:700; --bW:400;
        --r:6px; --bw:1px; --stripe:0; --stripeOp:0.05; --logoH:64px; --rowH:48px; --sp:16px;
      }
      @media print {
        * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
        body { background: var(--bg) !important; color: var(--txt) !important; }
        @page { margin: 12mm; size: A4; }
      }
      body { 
        font-family: var(--body), system-ui, -apple-system, Segoe UI, Roboto, sans-serif; 
        margin: 0; padding: var(--sp); background: var(--bg); color: var(--txt); 
        font-weight: var(--bW); font-size: 14px; line-height: 1.5;
      }
      #root { max-width: 210mm; margin: 0 auto; }
    </style>
  </head>
  <body>
    <div id="logoHolder" style="display:flex; justify-content:flex-start; margin-bottom:12px"></div>
    <h1 id="title">Invoice</h1>
    <div class="row">
      <div class="col" id="vendor"></div>
      <div class="col" id="client"></div>
    </div>
    <table id="items">
      <thead>
        <tr><th>#</th><th>Description</th><th>Qty</th><th>Unit</th><th>Amount</th></tr>
      </thead>
      <tbody></tbody>
      <tfoot id="totals"></tfoot>
    </table>
    <div class="footer-section" id="footerNotes"></div>
    <script>
      const LOGO_PX = { sm:36, md:64, lg:92 };
      const snap = localStorage.getItem("invoice:last");
      if(!snap){ document.body.innerHTML = "<p>No invoice data found. Export from the app first.</p>"; }
      else {
        const { invoice, totals, profile, theme, template } = JSON.parse(snap);
        const tokens = theme || {};
        const footer = (profile && profile.footer) || {};
        const logo = (profile && profile.logo) || {};

        // Live Customizer CSS Variables (matching ThemeVars.tsx)
        const r = document.documentElement;
        r.style.setProperty("--acc", tokens.accent || "#04A7A3");
        r.style.setProperty("--acc2", tokens.accent2 || "#027e7b");
        r.style.setProperty("--txt", tokens.text || "#0f172a");
        r.style.setProperty("--txtMuted", tokens.textMuted || "#64748b");
        r.style.setProperty("--bg", tokens.bg || "#ffffff");
        r.style.setProperty("--surface", tokens.surface || "#f8fafc");
        r.style.setProperty("--border", tokens.border || "#e2e8f0");
        r.style.setProperty("--heading", tokens.headingFont || "Inter");
        r.style.setProperty("--body", tokens.bodyFont || "Inter");
        r.style.setProperty("--hW", String(tokens.headingWeight || 700));
        r.style.setProperty("--bW", String(tokens.bodyWeight || 400));
        r.style.setProperty("--r", (tokens.radius || 12) + "px");
        r.style.setProperty("--bw", (tokens.borderWidth || 1) + "px");
        r.style.setProperty("--stripe", tokens.stripe ? "1" : "0");
        r.style.setProperty("--stripeOp", String(tokens.stripeOpacity || 0.45));
        r.style.setProperty("--logoH", (tokens.logoMaxH || 56) + "px");
        r.style.setProperty("--rowH", (tokens.tableRowH || 44) + "px");
        r.style.setProperty("--sp", (tokens.spacing || 12) + "px");

        // Logo (using Live Customizer tokens)
        const logoUrl = (logo && (logo.logoDataUrl || logo.logoUrl)) || 
                        (invoice && invoice.brand && (invoice.brand.logoDataUrl || invoice.brand.logoUrl)) || "";
        if (logoUrl) {
          const img = new Image();
          img.src = logoUrl;
          img.style.height = (tokens.logoMaxH || 56) + "px";
          img.style.width = "auto";
          img.style.objectFit = "contain";
          const holder = document.getElementById("logoHolder");
          holder.appendChild(img);
        }

        // Title + vendor/client
        document.getElementById("title").textContent = (invoice?.docType || "INVOICE") + (invoice?.code ? " • " + invoice.code : "");
        const vendor = document.getElementById("vendor");
        if (profile) {
          vendor.innerHTML = `<strong>${profile.businessName || ""}</strong><br/>${profile.address || ""}<br/>${profile.email || ""} ${profile.phone ? " • "+profile.phone : ""}`;
        }
        const client = document.getElementById("client");
        const c = invoice?.customer || {};
        client.innerHTML = `<strong>Customer</strong><br/>${c?.name || invoice?.customerName || ""}<br/>${c?.email || invoice?.customerEmail || ""} ${c?.phone ? " • "+c.phone : ""}`;

        // Items
        const fmt = (n, cur) => { try { return new Intl.NumberFormat(undefined,{style:'currency',currency:cur}).format(+n||0) } catch { return (cur||'USD')+' '+(Number(n||0)).toFixed(2) } };
        const tb = document.querySelector("#items tbody");
        (invoice?.items || []).forEach((it, i) => {
          const q = Number(it?.qty||it?.quantity||1)||1;
          const u = Number(it?.unitPrice||it?.price||0)||0;
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${i+1}</td><td>${it?.description || it?.title || ""}</td><td>${q}</td><td>${fmt(u, invoice?.currency || "USD")}</td><td>${fmt(q*u, invoice?.currency || "USD")}</td>`;
          tb.appendChild(tr);
        });

        // Styling table per theme
        if (theme.altRowStripesOn) document.getElementById("items").classList.add("stripe");
        if (theme.separators === "underline") document.getElementById("items").classList.add("sep-underline");
        if ((theme.totalsAlign || "right") === "right") document.getElementById("items").classList.add("totals-right");

        // Totals
        const tf = document.getElementById("totals");
        if (totals) {
          tf.innerHTML =
            `<tr><td colspan="4" style="text-align:right">Subtotal</td><td>${fmt(totals.subtotal ?? totals.subTotal ?? 0, invoice?.currency || "USD")}</td></tr>
             <tr><td colspan="4" style="text-align:right">Discount</td><td>${fmt(totals.discount ?? 0, invoice?.currency || "USD")}</td></tr>
             <tr><td colspan="4" style="text-align:right">Tax</td><td>${fmt(totals.tax ?? 0, invoice?.currency || "USD")}</td></tr>
             <tr><td colspan="4" style="text-align:right"><strong>Total</strong></td><td><strong>${fmt(totals.total ?? 0, invoice?.currency || "USD")}</strong></td></tr>`;
        }

        // Footer
        const fn = document.getElementById("footerNotes");
        const lines = [
          footer.notes || "",
          footer.contact || "",
          footer.socialsCsv || "",
          footer.legal || ""
        ].filter(Boolean);
        
        if (lines.length > 0) {
          // Color bar
          if (footer.colorBarOn && footer.colorBarHeightPx) {
            const colorBar = document.createElement('div');
            colorBar.className = 'color-bar';
            colorBar.style.height = footer.colorBarHeightPx + 'px';
            colorBar.style.backgroundColor = theme.brandPrimary || '#2d3e8b';
            fn.appendChild(colorBar);
          }
          
          fn.innerHTML += lines.join(" • ");
        }
      }
    </script>
  </body>
</html>